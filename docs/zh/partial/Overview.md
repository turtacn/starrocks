# StarRocks 部分可用应急方案

## 目标

在 StarRocks 的单副本（`num_replicas=1`）部署场景下，一张用户表可能被拆分为几十甚至上百个 Tablet。当任意一个 BE 节点宕机时，其上承载的所有 Tablet 都会变为不可用状态。为了保证查询的完整性，StarRocks 目前的机制是，一旦查询扫描到任何一个缺失的 Tablet，整个查询就会直接报错。这种机制虽然保证了数据的强一致性，但在单 BE 故障的情况下，会导致大面积的查询和写入失败，严重影响业务的可用性。此外，这也带来了数据永久丢失的风险。

为了应对这种紧急情况，我们提出一种“部分可用”的应急方案。其核心目标是：在单 BE 节点发生故障时，系统能够继续处理那些不触及故障 Tablet 的请求，从而在保证业务连续性的同时，最大限度地减少单点故障带来的影响。

## 设计

本方案的设计核心是在查询和写入路径上引入对 Tablet 可用性的判断和容错处理。

### 1. 查询路径修改

在查询计划生成阶段，FE（Frontend）会获取查询需要扫描的所有 Tablet 列表。此时，FE 会根据 BE 节点的心跳状态，识别出宕机节点上的不可用 Tablet。

对于不可用 Tablet，FE 会采取以下策略：
- **从扫描列表中移除：** FE 会将这些不可用 Tablet 从查询计划的扫描节点（OlapScanNode）中移除。
- **记录并告警：** 系统会记录被跳过的 Tablet 信息，并发出告警，通知运维人员有节点发生故障。
- **返回部分结果：** 查询将继续在剩余的可用 Tablet 上执行，并返回部分结果。同时，在返回给客户端的结果中，会包含一个明确的警告信息，告知用户本次查询结果可能不完整。

### 2. 写入路径修改

对于写入操作（如 Broker Load, Stream Load），同样会涉及到 Tablet 的选择。
- 在分配写入任务时，FE 将会跳过宕机 BE 节点上的 Tablet。
- 如果是更新或删除操作，并且需要操作的 Tablet 恰好在故障节点上，该操作将会失败，并向用户返回明确的错误信息，指明是由于部分副本不可用导致。

### 3. 配置开关

该“部分可用”功能将通过一个 FE 的配置项来控制，默认关闭。
```
// fe.conf
enable_partial_availability = false
```
只有在用户明确开启此开关后，系统才会在 BE 宕机时启用部分可用逻辑。这为用户提供了一个可控的应急手段，可以在可用性和一致性之间做出选择。

## 效果

引入部分可用方案后，预计将带来以下效果：

1.  **提升可用性：** 在单 BE 节点宕机的场景下，绝大部分不依赖于故障节点的查询和写入请求仍能成功执行，显著提升了系统的整体可用性和鲁棒性。
2.  **降低业务影响：** 对于业务方而言，单点故障不再是“全有或全无”的问题。核心业务只要不完全依赖于故障节点上的数据，就可以继续运行，大大降低了故障带来的冲击。
3.  **快速应急：** 在发生硬件故障等紧急情况时，运维团队可以先通过开启此功能来恢复大部分业务，然后再从容地进行节点修复和数据恢复，避免了长时间的服务中断。
4.  **风险可控：** 通过配置开关和明确的告警/提示信息，用户可以清楚地知道何时查询结果是不完整的，从而将数据不一致的风险控制在可接受的范围内。
